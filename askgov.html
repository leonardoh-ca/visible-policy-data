<script>
const repo = "visible-policy-data";
const owner = "leonardoh-ca";
const filePath = "comments.json";

async function fetchComments() {
  const res = await fetch(`https://raw.githubusercontent.com/${owner}/${repo}/main/${filePath}`);
  const data = await res.json();
  return data;
}

async function sendToGitHubAction(tweetList) {
  await fetch(`https://api.github.com/repos/${owner}/${repo}/dispatches`, {
    method: "POST",
    headers: {
      "Authorization": "Bearer YOUR_PERSONAL_ACCESS_TOKEN",
      "Accept": "application/vnd.github+json",
      "X-GitHub-Api-Version": "2022-11-28",
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      event_type: "update-comments",
      client_payload: {
        data: JSON.stringify(tweetList, null, 2)
      }
    })
  });
}

function toggleMode() {
  document.body.classList.toggle("dark");
}

let tweets = [];
const tweetsContainer = document.getElementById("tweets");

async function load() {
  tweets = await fetchComments();
  renderTweets();
}

function postTweet() {
  const name = document.getElementById("name").value.trim();
  const district = document.getElementById("district").value.trim();
  const question = document.getElementById("question").value.trim();
  if (!name || !district || !question) return;

  const tweet = {
    id: Date.now(),
    name,
    district,
    question,
    time: new Date().toLocaleString()
  };
  tweets.unshift(tweet);
  sendToGitHubAction(tweets).then(renderTweets);

  document.getElementById("name").value = "";
  document.getElementById("district").value = "";
  document.getElementById("question").value = "";
}

function deleteTweet(id) {
  tweets = tweets.filter(t => t.id !== id);
  sendToGitHubAction(tweets).then(renderTweets);
}

function renderTweets() {
  tweetsContainer.innerHTML = tweets.map(t => `
    <div class="tweet">
      <button class="delete-btn" onclick="deleteTweet(${t.id})"><i class="fas fa-trash"></i></button>
      <div class="meta">${t.name} Â· ${t.district}</div>
      <div class="time">${t.time}</div>
      <div class="text">${t.question}</div>
    </div>
  `).join('');
}

load();
</script>
